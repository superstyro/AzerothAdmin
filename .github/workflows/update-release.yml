name: Update Latest Release

on:
  push:
    branches:
      - master

jobs:
  update-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Get version from TOC file
        id: get_version
        run: |
          VERSION=$(grep -oP '^## Version:\s*\K.*' AzerothAdmin.toc | tr -d '[:space:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Get latest release tag
        id: latest_release
        run: |
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest release tag: $LATEST_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # Read changelog and extract the matching section
          CHANGELOG=$(awk -v version="$VERSION" '
            BEGIN { in_section=0; found=0 }
            /^### -=\[ Revision/ {
              if (in_section) exit
              if ($0 ~ version) {
                in_section=1
                found=1
                next
              }
            }
            in_section && /^### -=\[ Revision/ { exit }
            in_section { print }
            END { if (!found) print "No changelog entry found for version " version }
          ' CHANGELOG.md)

          # Write to output using heredoc to handle multiline
          {
            echo 'ENTRY<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create addon package
        run: |
          # Create a directory with the addon name
          mkdir -p AzerothAdmin

          # Copy all necessary files except git/github/docs/raw assets
          rsync -av --progress . AzerothAdmin/ \
            --exclude .git \
            --exclude .github \
            --exclude .gitignore \
            --exclude .claude \
            --exclude Docs \
            --exclude 'README.md' \
            --exclude 'CREDITS.md' \
            --exclude 'logo_raw.psd' \
            --exclude 'icon_raw.psd' \
            --exclude 'AA_char.jpg' \
            --exclude 'AA_gm.jpg' \
            --exclude 'AA_server.jpg' \
            --exclude 'logo.png'

          # Create the zip file
          zip -r AzerothAdmin-${{ steps.get_version.outputs.VERSION }}.zip AzerothAdmin/

      - name: Get commit info
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%B %d, %Y at %H:%M UTC')

          {
            echo 'COMMIT_MSG<<EOF'
            echo "$COMMIT_MSG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.latest_release.outputs.LATEST_TAG }}
          files: AzerothAdmin-${{ steps.get_version.outputs.VERSION }}.zip
          body: |
            ## What's Changed
            ${{ steps.changelog.outputs.ENTRY }}

            ## Installation
            1. Download `AzerothAdmin-${{ steps.get_version.outputs.VERSION }}.zip`
            2. Extract to your `World of Warcraft/Interface/AddOns/` folder
            3. The addon folder will be created automatically as `AzerothAdmin`

            ---
            **Last Updated:** ${{ steps.commit_info.outputs.COMMIT_DATE }}
            **Latest Commit:** ${{ steps.commit_info.outputs.COMMIT_SHA }} - ${{ steps.commit_info.outputs.COMMIT_MSG }}

            See [CHANGELOG.md](CHANGELOG.md) for full changelog.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
